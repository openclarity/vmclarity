package util

import (
	"github.com/openclarity/vmclarity/api/models"
	"github.com/openclarity/vmclarity/shared/pkg/families/malware"
	"strings"
)

const detectedMalwareClamLineWordCount = 3 // A clam detected malware line should be in the following format: <path> <malware-description> <FOUND/OK>
const maxClamMalwareDescSections = 3       // In some cases, the malware description includes the platform (i.e: Win.Trojan.Generic-123)
const clamDetectedMalwarePathPosition = 0
const clamDetectedMalwareDescPosition = 1
const longClamAVMalwareTypePosition = 1
const malwareDetectedIndication = "FOUND" // When a line in a clam scan includes the word "FOUND", it describes a malware detection

func ParseMalwareScanOutput(malwareResults *malware.Results) []models.Malware {
	lines := strings.Split(malwareResults.ClamAVOutput, "\n")

	var malwareInfoList []models.Malware

	for _, line := range lines {
		// Check if the line starts with "FOUND" to identify malware detections
		if strings.Contains(line, malwareDetectedIndication) {
			words := strings.Fields(line)

			// If the line has less than 3 words in it, it can't be a malware detection, so we skip it
			if len(words) < detectedMalwareClamLineWordCount {
				continue
			}

			malwareInfo := extractMalwareInfo(words)

			// Add the malware info to malware info list
			malwareInfoList = append(malwareInfoList, models.Malware{
				MalwareInfo: malwareInfo,
			})
		}
	}
	return malwareInfoList
}

func extractMalwareInfo(words []string) *models.MalwareInfo {
	// Extract the file path from the words
	filePath := strings.TrimSuffix(words[clamDetectedMalwarePathPosition], ":")

	// Extract the malware name and type from the words
	malwareDesc := words[clamDetectedMalwareDescPosition]
	splitMalwareDesc := strings.SplitN(malwareDesc, ".", maxClamMalwareDescSections)
	var malwareType models.MalwareType

	malwareTypeIndex := 0
	if len(splitMalwareDesc) == maxClamMalwareDescSections {
		malwareTypeIndex = longClamAVMalwareTypePosition
	}

	malwareType = models.MalwareType(strings.ToUpper(splitMalwareDesc[malwareTypeIndex]))
	malwareName := splitMalwareDesc[len(splitMalwareDesc)-1]

	// Create a new MalwareInfo struct
	return &models.MalwareInfo{
		MalwareName: &malwareName,
		MalwareType: &malwareType,
		Path:        &filePath,
	}
}
