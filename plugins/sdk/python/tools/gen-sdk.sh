#!/usr/bin/env bash

## Consts
OPENAPI_GENERATOR_IMAGE="openapitools/openapi-generator-cli:v7.5.0"

## Script vars
SCRIPT_PATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
PLUGIN_PATH="$(realpath $SCRIPT_PATH/../../..)"
SDK_PATH="$(realpath $SCRIPT_PATH/..)"

## Generate code
echo "Generating Python server code from $PLUGIN_PATH"
docker run --rm \
  -u $(id -u ${USER}):$(id -g ${USER}) \
  -v ${PLUGIN_PATH}:/src $OPENAPI_GENERATOR_IMAGE \
  generate \
  -i /src/openapi.yaml \
  -g python-flask \
  -o /src/sdk/python/generated \
  --package-name "plugin" \
  --additional-properties "legacyDiscriminatorBehavior=false"

## Remove unused generated code
rm -rf $SDK_PATH/generated/plugin/controllers
rm -rf $SDK_PATH/generated/plugin/test
rm -rf $SDK_PATH/generated/plugin/openapi
rm -rf $SDK_PATH/generated/plugin/__main__.py

## Move autogenerated code
cp -R $SDK_PATH/generated/plugin/*      $SDK_PATH/plugin/
cp $SDK_PATH/generated/.dockerignore    $SDK_PATH/
cp $SDK_PATH/generated/.gitignore       $SDK_PATH/
cp $SDK_PATH/generated/requirements.txt $SDK_PATH/
cp $SDK_PATH/generated/setup.py         $SDK_PATH/

## Cleanup
rm -rf $SDK_PATH/generated
